const Annonce=require("../models/annonce"),compressImages=require("compress-images"),fs=require("fs"),nMailer=require("nodemailer");confirmMailing=(req,titre,mdp,id,mail)=>{let transporter;console.log("IN da MAILER"),nMailer.createTransport({sendmail:!0,newline:"unix",path:"/usr/sbin/sendmail",secure:!0,dkim:{domainName:"piecederecup.fr",keySelector:"default",privateKey:"MIIEpAIBAAKCAQEAy8wfYxqhDWxa7/E3N5Dc8UXU1PD1jAQTmII7qgrCSD8kUzbDJPclPMuPpOVJFtCA7OLyjaC08c2hDm3T1aEJvkeULYlynzXXojPrnicrIwh6m/IplGqhRnmAOct+D1TokmP+/dXnqqmgie1NmFzJPfGh/FO5y0FvLpnvwJqTQKjuE5j1PwsXuUuNQZjaMR5G2vYRJb9IPRmGB1bMIGxvbsQDMPIUUzXWrv+QUVKgZ5t3zCMIBCMhW/VrnmOPH7YzQhnPpHiwigNZ0V1Mvpl00I7jDBxJ1d6k6juItZJsiRXAXAGsxr9g9NrpPA+/In7TqFiyXQZK8tIeLqQf3HBPKQIDAQABAoIBAQDA24s8Wt/b9xVbiXbKg7FCNeZCGUEVXmo44c2ajhHrEq3KfcFQQv2fObfWwRBYobnP8ri8pD93sDNglzhnKr0wr0YfjbnFxssn+WBYyxI8VfLJjvIgPIQgUCyzBMpnsd9hYXXWOs3AKEP/Im1S6UOb9gVn5sek/Gg9vnkvWFhPT5zqsSpA0xBI4tM/i69mj+5IXtCX3IV6CSyo2b5N9wqzyM0R6UL2a9QZqUFW+wZdMdY5lUFbhxcnFA+HHgnDTEqfIKUUIs6+OeYNYbM+P/KUzKthKMESfjyj0lvrS8HZNAnYHRD80iP3SOXNEej5/7tZE7keqLdp4XweTPZXgxwBAoGBAPIZjVm81lY4R6aj92mZ5SF/Dvo6/sQbM66fsWHqmr+33TBQbU1zdQZTa35Acnk2sB9q/X+d8Frro6Aiooog0wSKvg/J3eDaxOinNPIFzhLRf6a7IwIbAHNwKP08bt/Ag6VFV1DdKZfdBt6DK71u0mrr86alFHdatXqh+QyM+L6pAoGBANd/lzVyC2hXHBSr/cx/obUBCanx/dyTZoWOJfcd7ReNpH25/A2nd8IuUwAdAGCMtSiGSDsnL6XKolmQhtXCniARttC8xhmDfsSdVfOFBfGyhG0i2GwWGC356/ndDpN+0gQOEmL4rPnoA0aLzNQ8IFPpgK4sahWpJ+UxuqWXp9yBAoGBAKhp6hCg8qFr6TwdGAGYEvLoRm0AGTYmjh9N68FnyFrR9sajTEXyqVfLNB3Ri1CTIJXagZoDLq6w+VRug49/Igwoz+p/zR+cUBpgJs6uBxrELf64c7QFQJ0NSxZOsfppG6sev4z7LPH9yceEjCrtKudCWG52q/QTX+d9QZjfgDJxAoGAB39A23MkQnUFXRK+uaaXEZz/oRHyKwJVxr+zQm2gGfmrh1Q5GKCC4haKfK6FnNZIVyiUyroKRlJOY59LkZQ7vBHhslFe8vRILL7shpRSKJ51TPaxYNFD9hWDyCWQpED9PXbf3OGZ4vfXZVTnw1p0JXcyKt0Qs8A2yxp3y9sC1AECgYBgKkUHQ91YI8jDUWvzMW0FOLMjnRvfSGd1sKAQUpWBo81xEFFT17hpwYOa/2FFTB3J/NlAsVpKWAe/obzMUcAQISxXjOKivU8wjn0/ljNQnDaiBiPGrVKxncVXPiv1qyxAO0sk45klgJNIJnyyg9NsrjzWA4V6Jd8wevhmemd9pg=="}}).sendMail({to:`${mail}`,from:'"Piece de Recup\'" <confirm@piecederecup.fr>',subject:`votre annonce ${titre}`,text:`Votre annonce ${titre} est bien disponible sur piecederecup.fr, votre mot de passe est: ${mdp}`,html:`<h1>Votre annonce sur Piece de Recup'</h1><br /><p>Votre annonce <strong>${titre}</strong> est bien disponible sur <a href="https://piecederecup.fr" target="_blank">piecederecup.fr</a> à l'adresse :<br /><a href="${req.protocol}://${req.get("host")}/page/annonce.html?id=${id}">${req.protocol}://${req.get("host")}/page/annonce.html?id=${id}</a> <br />Le mot de passe que vous avez choisi pour la supprimer est : <i>${mdp}</i><br />Elle sera disponible en ligne tant que vous ne l'aurez pas supprimé. <br />En vous souhaitant une bonne vente sur pieccederecup.fr .<br /><br/>Ceci est mail automatique, merci de ne pas répondre.</p>`})};const compressPhoto=(req,res)=>{let INPUT_path=`${req.file.path}`;const entree=Date.now();let OUTPUT_path;compressImages(INPUT_path,"./images/comp-",{compress_force:!1,statistic:!0,autoupdate:!0},!1,{jpg:{engine:"mozjpeg",command:["-quality","20"]}},{png:{engine:"pngquant",command:["--quality=20-35","-o"]}},{svg:{engine:"svgo",command:"--multipass"}},{gif:{engine:"gifsicle",command:["--colors","80","--use-col=web"]}},(function(error,completed,statistic){statistic.size_output?(console.log("------Rapport de compression------"),console.log("Completed :",completed),console.log("Statistic :",statistic),console.log("Erreur :",error),console.log("------------------------------")):(console.log("Completed :",completed),console.log("PROBLEME DE COMPRESSION"),console.log("Erreur :",error))}));const delFile=`./temp/${req.file.filename}`;console.log("url to del :",delFile)};exports.delFile=req=>{const delFile=req.body.delUri;fs.unlink(delFile,err=>{err?console.error(`Error delete file: ${delFile}`):console.error(`\nDeleted file: ${delFile}`)})},exports.getAll=(req,res)=>{Annonce.find().then(all=>{res.status(200).json(all)}).catch(error=>console.error(error))},exports.getAccueil=(req,res)=>{Annonce.find().limit(10).then(all=>{res.status(200).json(all)}).catch(error=>console.error(error))},exports.getOne=(req,res)=>{Annonce.findOne({_id:req.params.id}).then(result=>{res.status(200).json(result)}).catch(error=>console.error(error))},exports.getRecherche=(req,res)=>{const reqArray=Object.values(req.body),size=reqArray.length,categorie=req.body.categorie,objet=req.body.objet,piece=req.body.piece,region=req.body.region,departement=req.body.departement,marque=req.body.marque,modele=req.body.modele,annee=req.body.annee,Recherche={categorie:categorie,objet:objet,piece:piece,region:region,departement:departement},details=[{marque:marque},{modele:modele},{annee:annee}],queryBase=Annonce.find({...Recherche});if(marque||modele||annee){switch(size){case 7:delete Recherche.departement;break;case 6:delete Recherche.departement,delete Recherche.region}const findWithDetails=Annonce.find({...Recherche,$or:details});findWithDetails.then(match=>{0==match.length?res.status(200).json({result:0}):res.status(200).json(match)}).catch(error=>console.error(error))}else queryBase.then(match=>{0==match.length?res.status(200).json({result:0}):res.status(200).json(match)}).catch(error=>console.error(error))},exports.postAnnonce=(req,res)=>{const ladate=new Date;console.log("req.post :",req.body);const annonce=new Annonce({...req.body,urlImg:`https://piecederecup.fr/engin/images/comp-${req.file.filename}`,date:ladate.getDate()+"/"+(ladate.getMonth()+1)+"/"+ladate.getFullYear(),heure:ladate.getHours()+":"+ladate.getMinutes()+":"+ladate.getSeconds()});annonce.save().then(annonce=>{compressPhoto(req,res);const apres=Date.now(),delFile=`./temp/${req.file.filename}`,mdp=req.body.mdp,titre=req.body.titre,mail=annonce.email,aid=annonce._id;confirmMailing(req,titre,mdp,aid,mail),res.status(201).json({message:"Votre annonce est bien enregistrée sur le site.\n Un email de confirmation vous a été envoyé.\nVérifiez dans le dossier SPAM si nécessaire.",aid:aid,codeOp:200,uriDel:delFile})}).catch(error=>{console.error(error),res.status(500).json({message:"Il y a eu un probleme avec votre photo\nVeuillez réitérer votre demande",aid:aid,codeOp:500})})},exports.delAnnonce=(req,res)=>{const id=req.body.id,mdp=req.body.mdp;Annonce.findOne({_id:id}).then(todel=>{setTimeout((function(){if(todel)if(todel.mdp===mdp){const filename=todel.urlImg.split("/images/")[1];console.log("file name to del : ",filename),fs.unlink(`images/${filename}`,()=>{Annonce.deleteOne({_id:req.body.id}).then(()=>res.status(200).json({message:"/page/message/confirmation-suppression.html"})).catch(()=>res.status(500))})}else res.status(403);else res.status(404)}),500)}).catch(()=>res.status(500))};